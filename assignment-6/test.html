<?php
	require_once ("../libs/customer_class.php");

	// initialize object
	$objCustomer = new Customer();

	if ($_POST[acfs3_addCustomerBtn] == "Add"){
		
		$customerId = $objCustomer->getNewCustomerId();
		
		$insertData = "$customerId,
						'".$_SESSION[loggedUserId]."',		
						'".$_SESSION[customerPPsNo]."',		
						'".$_SESSION[customerAuthBoardCode]."',
						'".$_SESSION[customerBrCode]."',
						'".$_SESSION[customerDealerCode]."',
						'".$_SESSION[customerUmCode]."',
						'".$_SESSION[customerMoCode]."',
						'".$_SESSION[customerSlNo]."',
						'".$_SESSION[customerFormNo]."',
						'".$_SESSION[customerLoginId]."',
						'".$_SESSION[customerPassword]."',
						1,
						'".$_SESSION[customerName]."',
						'',
						'".$_SESSION[customerPreAddress]."',
						'".$_SESSION[customerPhoneNo]."',
						'".$_SESSION[customerEmail]."',
						'',
						'".$_SESSION[customerJoiningProductCode]."',
						'".$_SESSION[firstPurchesDate]."',
						'".$_SESSION[lastPurchesDate]."',
						DATE_ADD(now(), INTERVAL 3 YEAR),
						'".$_SESSION[purchesVolume]."',
						".$_SESSION[loggedUserId].",
						0,now(),now(),1";
						

		// call insert operation i.e save data to table
		$insertResult = $objCustomer->insertCustomerInfo($insertData);

		$insertData = "$customerId,
						'".$_SESSION[customerFHFlag]."',		
						'".$_SESSION[customerFHName]."',
						'".$_SESSION[customerMName]."',
						'".$_SESSION[customerParAddress]."',
						'".$_SESSION[customerNationalId]."',
						'".$_SESSION[customerNomName]."',
						'',
						'".$_SESSION[customerNomRelation]."',
						'".$_SESSION[customerNomDOB]."',
						'".$_SESSION[customerNomAge]."',
						'".$_SESSION[customerGuarName]."',
						'".$_SESSION[customerGuarRelation]."',
						'".$_SESSION[customerGuarDOB]."',
						'".$_SESSION[customerGuarAge]."',
						now()";

		// call insert operation i.e save data to table
		$insertAction = $objCustomer->insertCustomerDlInfo($insertData);		
		
		if($insertAction){
			$_SESSION[actionResult] = '<div id="confermationSection" class="width95">
											<h3>Congratulations! Operation Successful</h3>
											<span>Customer has been added successfully.From now the Customer by the Login ID: <u>'.$_SESSION[customerLoginId].'</u> and Password: <u>'.$_SESSION[customerPasswordTxt].'</u> can access your system.<br /> Thank You...</span>
										</div>';
		
		}else{
			$_SESSION[actionResult] = '<div id="errorSection" class="width95">
											<h3>Error Occured:</h3>
											<span>Sorry! Customer add operation failed <br /> Please contact system admin. Sorry for the inconvenience</span>
										</div>';
			
		}
			
		$_SESSION[customerPPsNo] = "";		
		$_SESSION[customerAuthBoardCode] = "";
		$_SESSION[customerBrCode] = "";
		$_SESSION[customerDealerCode] = "";
		$_SESSION[customerUmCode] = "";
		$_SESSION[customerMOCode] = "";
		$_SESSION[customerSlNo] = "";
		$_SESSION[customerPPsNo] = "";
		$_SESSION[customerFormNo] = "";
		$_SESSION[customerLoginId] = "";
		$_SESSION[customerPassword] = "";
		$_SESSION[customerConfPassword] = "";
		$_SESSION[customerPasswordTxt] = "";
		$_SESSION[customerJoiningProductCode] = "";
		$_SESSION[firstPurchesDate] = "";
		$_SESSION[lastPurchesDate] = "";
		$_SESSION[purchesExpireDate] = "";
		$_SESSION[purchesVolume] = "";
		$_SESSION[customerName] = "";
		$_SESSION[customerPreAddress] = "";
		$_SESSION[customerPhoneNo] = "";
		$_SESSION[customerEmail] = "";
		$_SESSION[customerFHFlag] = "";	
		$_SESSION[customerFHName] = "";
		$_SESSION[customerMName] = "";
		$_SESSION[customerParAddress] = "";
		$_SESSION[customerNationalId] = "";
		$_SESSION[customerNomName] = "";
		$_SESSION[customerNomRelation] = "";
		$_SESSION[customerNomDOB] = "";
		$_SESSION[customerNomAge] = "";
		$_SESSION[customerGuarName] = "";
		$_SESSION[customerGuarRelation] = "";
		$_SESSION[customerGuarDOB] = "";
		$_SESSION[customerGuarAge] = "";
		
		
		header("Location:".APP_URL."dashboard.php?page=customer_add");

	}elseif($_POST[acpf_uploadBtn] == "UPLOAD"){
	
		// scan form data
		$customerId = $_POST[acpf_customerId];
		$customerName = $_POST[acpf_customerName];
		
		// check for valid member login id
		$fileName = $_FILES["acpf_customerImageFile"]["name"];
		$fileType = $_FILES["acpf_customerImageFile"]["type"];
		$fileSize = $_FILES["acpf_customerImageFile"]["size"];
		$fileError = $_FILES["acpf_customerImageFile"]["error"];
		
		if($customerId != ""){
			if ((($fileType == "image/gif")
				|| ($fileType == "image/jpeg")
				|| ($fileType == "image/pjpeg"))
				&& ($fileSize < 60000)) {
			
				if ($fileError > 0){
					echo "Return Code: " . $fileError . "<br />";
					$_SESSION[resultAction] = '<div class="errorMsg">
												<h3>Error Occured [Please Report to system admin]:</h3>
												'.$fileError.'</div>';
				}else {
					$fileNameWithExtension = basename($fileName);
					$nameArray = explode(".",$fileNameWithExtension);
					$newFileName = $customerId.'_'.substr(md5($customerName),3,5).'.'.$nameArray[1];
					$uploadDir = "../../images/uploads/";
					$newFileNameWithDir = $uploadDir.$newFileName;
					
					if (file_exists($newFileNameWithDir)) {
						unlink($newFileNameWithDir);
					} 
					// Upload the file		
					move_uploaded_file($_FILES["acpf_customerImageFile"]["tmp_name"],$newFileNameWithDir);
					if($customerId){
						$updateData = "SET customer_image='$newFileName' WHERE 	customer_id=$customerId";
						$updateAction = $objCustomer->updateCustomerInfo($updateData);
						if($updateAction){
							$_SESSION[resultAction] = '<div id="confermationSection" class="width95">
															<h3>Photo has been Uploaded Successfully</h3>
															<span>Photo For <u>'.$customerName.'</u>['.$newFileName.'] uploaded successfully. Thank You.</span>
														</div>';
							
						}else{
							$_SESSION[resultAction] = '<div id="errorSection" class="width95">
															<h3>Upload Operation Failed</h3>
															<span>Please contact your system admin for the inconvenience.</span>
														</div>';
						}
					}
				}
						
			}else {
				$_SESSION[resultAction] .= '<div id="errorSection" class="width95">
												<h3>Error Occured [Invalid file]</h3>
												<span>Photo For <u>'.$customerName.'</u>['.$newFileName.'] could not upload. Please, confirm correct file format. Sorry for the inconvenience.</span>
											</div>';
				
			}
		
		}else{
			$_SESSION[resultAction] = '<div id="errorSection" class="width95">
											<h3>Error Occured [Invalid file]</h3>
											<span>Invalid Customer Photo Upload Action has been Taken ['.$customerId.']<br />
										Please first search for a valid Customer Login ID or PPS NO. then try again..</span>
										</div>';
		}

		header("Location:".APP_URL."dashboard.php?page=upload_photo");
	
	}elseif($_POST[acnpf_uploadBtn] == "UPLOAD"){
	
		// scan form data
		$customerDlId = $_POST[acnpf_customerDlId];
		$customerNomName = $_POST[acnpf_customerNomName];
		
		// check for valid member login id
		$fileName = $_FILES["acnpf_customerImageFile"]["name"];
		$fileType = $_FILES["acnpf_customerImageFile"]["type"];
		$fileSize = $_FILES["acnpf_customerImageFile"]["size"];
		$fileError = $_FILES["acnpf_customerImageFile"]["error"];
		
		if($customerDlId != ""){
			if ((($fileType == "image/gif")
				|| ($fileType == "image/jpeg")
				|| ($fileType == "image/pjpeg"))
				&& ($fileSize < 60000)) {
			
				if ($fileError > 0){
					echo "Return Code: " . $fileError . "<br />";
					$_SESSION[resultAction] = '<div class="errorMsg">
												<h3>Error Occured [Please Report to system admin]:</h3>
												'.$fileError.'</div>';
				}else {
					$fileNameWithExtension = basename($fileName);
					$nameArray = explode(".",$fileNameWithExtension);
					$newFileName = $customerDlId.'_'.substr(md5($customerNomName),3,5).'.'.$nameArray[1];
					$uploadDir = "../../images/uploads/";
					$newFileNameWithDir = $uploadDir.$newFileName;
					
					if (file_exists($newFileNameWithDir)) {
						unlink($newFileNameWithDir);
					} 
					// Upload the file		
					move_uploaded_file($_FILES["acnpf_customerImageFile"]["tmp_name"],$newFileNameWithDir);
					if($customerDlId){
						$updateData = "SET cdl_nom_image='$newFileName' WHERE 	cdl_id=$customerDlId";
						$updateAction = $objCustomer->updateCustomerDlInfo($updateData);
						if($updateAction){
							$_SESSION[resultAction] = '<div id="confermationSection" class="width95">
															<h3>Photo has been Uploaded Successfully</h3>
															<span>Photo For <u>'.$customerNomName.'</u>['.$newFileName.'] uploaded successfully. Thank You.</span>
														</div>';
							
						}else{
							$_SESSION[resultAction] = '<div id="errorSection" class="width95">
															<h3>Upload Operation Failed</h3>
															<span>Please contact your system admin for the inconvenience.</span>
														</div>';
						}
					}
				}
						
			}else {
				$_SESSION[resultAction] .= '<div id="errorSection" class="width95">
												<h3>Error Occured [Invalid file]</h3>
												<span>Photo For <u>'.$customerNomName.'</u>['.$newFileName.'] could not upload. Please, confirm correct file format. Sorry for the inconvenience.</span>
											</div>';
				
			}
		
		}else{
			$_SESSION[resultAction] = '<div id="errorSection" class="width95">
											<h3>Error Occured [Invalid file]</h3>
											<span>Invalid Customer Nominee Photo Upload Action has been Taken ['.$customerDlId.']<br />
										Please first search for a valid Customer Login ID or PPS NO. then try again..</span>
										</div>';
		}

		header("Location:".APP_URL."dashboard.php?page=upload_nominee_photo");
	}elseif(isset($_POST[aif_activaeInactiveBtn])){
	 	// scan form data
		$customerId = $_POST[aif_customerId];
		$customerStatus = $_POST[aif_customerStatus];
		if($customerStatus == 0){
			$customerStatus = 1;
			$action = "Activation";
			$accomplishedAction = "Activated";
		}else{
			$customerStatus = 0;
			$action = "Inactivation";
			$accomplishedAction = "Inactivated";
		}
		// nesting data to update record
		$updateData = "SET customer_status=$customerStatus, customer_udate=now() WHERE customer_id=$customerId";
		
		$updateAction = $objCustomer->updateCustomerInfo($updateData);
		
		if($updateAction){
			$_SESSION[actionResult] = '<div id="confermationSection" class="width95">
											<h3>Congratulations! '.$action.' Successful:</h3> 
											<span>The customer has been '.$accomplishedAction.' successfully<br />Thank You...<span></div>';
		}else{
			$_SESSION[actionResult] = '<div id="errorSection" class="width95">
											<h3>Error Occured:</h3>
											<span>Sorry! The customer Activa-Inactive operation can not be done.<br /> Please contact your system admin and try again... </span></div>';
		}
		header("Location: ".APP_URL."dashboard.php?page=customer_mang");
	
	}elseif($_POST[df_delBtn] == "Delete"){
		
		$customerId = $_POST[df_customerId];
		
		// deletes customer's record
		$dataSet = "WHERE customer_id=$customerId";
		
		$deleteAction = $objCustomer->deleteCustomerById($dataSet);
		
		// deletes customer's detail record
		$dataSet = "WHERE cdl_id=$customerId";

		$deleteAction = $objCustomer->deleteCustomerDetailById($dataSet);
		
		if($deleteAction){
			$_SESSION[actionResult] = '<div id="confermationSection" class="width95">
											<h3>Congratulations! Delete Successful:</h3> 
											<span>The customer has been Deleted successfully<br />
											The customer will not be available in your system any more. Thank You...</span></div>';
		}else{
			$_SESSION[actionResult] = '<div id="errorSection" class="width95">
											<h3>Error Occured:</h3>
											<span>Sorry! The customer can not be Deleted.<br /> Please contact your system admin and try again...</span></div>';
		}
		header("Location: ".APP_URL."dashboard.php?page=customer_mang");
	}
	
?>